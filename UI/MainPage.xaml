<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="UI.MainPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:vm="clr-namespace:UI.ViewModels.MainPageViewModel;assembly=UI"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:effects="clr-namespace:UI.Effects"
    xmlns:controls="clr-namespace:UI.Controls"
    xmlns:converters="clr-namespace:UI.Converters"
    xmlns:local="clr-namespace:UI.Views"
    x:DataType="vm:MainViewModel"
    Title="TreeGlyph">

    <Grid Padding="20" RowSpacing="12">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- 🧭 Navigation Bar -->
        <Grid Grid.Row="0"
              HeightRequest="44"
              Padding="12,0"
              BackgroundColor="{AppThemeBinding Light=#f5f5f5, Dark=#222222}"
              ColumnSpacing="12"
              HorizontalOptions="Fill"
              ColumnDefinitions="Auto,*,Auto">

            <!-- 🔧 Navigation Buttons -->
            <HorizontalStackLayout Grid.Column="0" Spacing="6" VerticalOptions="Center">
                <Button Text="Browse" Command="{Binding BrowseFolderCommand}" Style="{StaticResource NavButtonStyle}" />
                <Button Text="Generate" Command="{Binding GenerateTreeCommand}" Style="{StaticResource NavButtonStyle}" IsEnabled="{Binding HasSelectedFolder}" />
                <Button Text="Save ASCII" Command="{Binding SaveTreeCommand}" Style="{StaticResource NavButtonStyle}" IsEnabled="{Binding HasSelectedFolder}" />
                <Button Text="Clear" Command="{Binding ClearTreeCommand}" Style="{StaticResource NavButtonStyle}" IsEnabled="{Binding HasSelectedFolder}" />
                <Button Text="Save Ignore" Command="{Binding SaveIgnoreFileCommand}" Style="{StaticResource NavButtonStyle}" IsEnabled="{Binding HasSelectedFolder}" />

                <!-- 🧠 Auto-Save Toggle -->
                <HorizontalStackLayout VerticalOptions="Center" Spacing="6">
                    <Label Text="Auto-Save" FontSize="12" VerticalOptions="Center" TextColor="{AppThemeBinding Light=Black, Dark=White}" Opacity="{Binding HasSelectedFolder, Converter={StaticResource BoolToOpacityConverter}}" />
                    <Switch IsToggled="{Binding AutoSaveIgnoreFile}" IsEnabled="{Binding HasSelectedFolder}" OnColor="{AppThemeBinding Light=#4caf50, Dark=#80e27e}" ThumbColor="{AppThemeBinding Light=White, Dark=LightGray}" VerticalOptions="Center" />
                </HorizontalStackLayout>
            </HorizontalStackLayout>

            <!-- 📖 About -->
            <HorizontalStackLayout Grid.Column="2" HorizontalOptions="End" VerticalOptions="Center">
                <Button Text="About" Command="{Binding ShowAboutCommand}" Style="{StaticResource NavButtonStyle}" />
            </HorizontalStackLayout>
        </Grid>

        <!-- 📁 Selected Folder Path -->
        <VerticalStackLayout Grid.Row="1" Spacing="6">
            <Label Text="Selected Folder:" FontAttributes="Bold" />
            <Label Text="{Binding SelectedFolderPath}" LineBreakMode="WordWrap" />
        </VerticalStackLayout>

        <!-- 🔀 Split Layout -->
        <controls:HorizontalSplitterView Grid.Row="2"
                                         Panel1Width="{Binding LeftPanelWidth, Mode=TwoWay}"
                                         MinWidth="240"
                                         MaxWidth="640"
                                         VerticalOptions="Fill"
                                         HorizontalOptions="Fill">

            <!-- 📄 Left Panel: Exclude Rules -->
            <controls:HorizontalSplitterView.Panel1Content>
                <VerticalStackLayout Padding="12" Spacing="8">
                    <Label Text="Exclude Patterns (.gitignore-style):" FontAttributes="Bold" />
                    <Editor Text="{Binding Exclusions}"
                AutoSize="TextChanges"
                HeightRequest="100"
                FontFamily="Consolas"
                BackgroundColor="LightGray"
                TextColor="Black" />

                    <!-- 🌐 Global Ignore Trigger -->
                    <Button Text="Edit Global Ignore Rules"
                Command="{Binding EditGlobalIgnoreCommand}"
                Style="{StaticResource NavButtonStyle}"
                Margin="0,6" />

                    <!-- 🌐 Global Ignore Editor -->
                    <Border IsVisible="{Binding IsEditingGlobalIgnore}"
                BackgroundColor="{AppThemeBinding Light=#f9f9f9, Dark=#1c1c1c}"
                Stroke="{AppThemeBinding Light=Gray, Dark=DarkGray}"
                StrokeShape="RoundRectangle 8"
                Padding="12"
                Margin="0,6">
                        <VerticalStackLayout Spacing="6">
                            <Label Text="Global Exclude Patterns (applied to all folders):"
                       FontAttributes="Bold" />
                            <Editor Text="{Binding GlobalIgnoreExclusions}"
                        FontFamily="Consolas"
                        AutoSize="TextChanges"
                        BackgroundColor="LightGray"
                        TextColor="Black"
                        HeightRequest="120" />
                            <HorizontalStackLayout HorizontalOptions="End">
                                <Button Text="Save Global Ignore"
                            Command="{Binding SaveGlobalIgnoreCommand}"
                            Style="{StaticResource NavButtonStyle}" />
                            </HorizontalStackLayout>
                        </VerticalStackLayout>
                    </Border>

                    <!-- ✅ Apply Global Ignore Manually -->
                    <Button Text="Apply Global Ignore to This Folder"
                Command="{Binding ApplyGlobalIgnoreCommand}"
                Style="{StaticResource NavButtonStyle}"
                Margin="0,6"
                IsEnabled="{Binding HasSelectedFolder}" />
                </VerticalStackLayout>
            </controls:HorizontalSplitterView.Panel1Content>


            <controls:HorizontalSplitterView.Panel2Content>
                <Grid ColumnDefinitions="*,Auto" Padding="12" ColumnSpacing="8">

                    <!-- 🌲 Tree Preview Section -->
                    <Grid Grid.Column="0" RowDefinitions="Auto,*" RowSpacing="8">
                        <Button Grid.Row="0"
                    Text="Copy Preview"
                    Command="{Binding CopyPreviewCommand}"
                    Style="{StaticResource NavButtonStyle}"
                    IsEnabled="{Binding HasSelectedFolder}"
                    HorizontalOptions="End" />

                        <Border Grid.Row="1"
                            StrokeShape="RoundRectangle 6"
                            Stroke="{AppThemeBinding Light=#333333, Dark=#444444}"
                            Background="{AppThemeBinding Light=#f9f9f9, Dark=#121212}"
                            Padding="6"
                            VerticalOptions="Fill"
                            HorizontalOptions="Fill">
                            <ScrollView VerticalScrollBarVisibility="Always"
                                HorizontalScrollBarVisibility="Always"
                                VerticalOptions="Fill"
                                HorizontalOptions="Fill">
                                <Editor Text="{Binding TreeOutput}"
                                    FontFamily="Consolas"
                                    BackgroundColor="Transparent"
                                    TextColor="{AppThemeBinding Light=Black, Dark=LightGray}"
                                    AutoSize="Disabled"
                                    IsReadOnly="True"
                                    VerticalOptions="Start"
                                    HorizontalOptions="Fill"
                                    WidthRequest="1000"
                                    HeightRequest="800" />
                            </ScrollView>
                        </Border>
                    </Grid>

                    <!-- ⚙️ Options Panel + Tab (Unified Sliding Container) -->
                    <AbsoluteLayout Grid.Column="1">

                        <!-- 🧩 Floating Drawer Container -->
                        <Grid x:Name="OptionsPanelContainer"
                            WidthRequest="272" 
                            HeightRequest="400"
                            TranslationX="288"
                            AbsoluteLayout.LayoutBounds="1,0.85,272,400"
                            AbsoluteLayout.LayoutFlags="PositionProportional">

                            <!-- ⚙️ Options Panel -->
                            <Grid WidthRequest="240"
                              HeightRequest="400"
                              HorizontalOptions="Start"
                              VerticalOptions="Fill">
                                <Border BackgroundColor="{AppThemeBinding Light=#f0f0f0, Dark=#1a1a1a}"
                    Stroke="{AppThemeBinding Light=Gray, Dark=DarkGray}"
                    StrokeShape="RoundRectangle 8"
                    Padding="12"
                    VerticalOptions="Fill"
                    HorizontalOptions="Fill">
                                    <Border.Shadow>
                                        <Shadow Brush="Black" Opacity="0.2" Radius="8" Offset="4,4" />
                                    </Border.Shadow>

                                    <VerticalStackLayout Spacing="12">

                                        <!-- ❌ Close Button -->
                                        <Button Text="✖"
                            HorizontalOptions="End"
                            Command="{Binding OptionsPanel.TogglePanelCommand}"
                            BackgroundColor="Transparent"
                            FontSize="18"
                            Padding="0"
                            WidthRequest="32"
                            HeightRequest="32"
                            TextColor="{AppThemeBinding Light=Black, Dark=White}" />

                                        <!-- 📏 Max Depth -->
                                        <Label Text="Max Depth:"
                           FontSize="14"
                           TextColor="{AppThemeBinding Light=Black, Dark=White}" />
                                        <Slider Minimum="1"
                            Maximum="99"
                            Value="{Binding OptionsPanel.MaxDepth}" />
                                        <Label Text="{Binding OptionsPanel.MaxDepth, StringFormat='Max Depth: {0}'}"
                           FontSize="14"
                           TextColor="{AppThemeBinding Light=Black, Dark=White}" />

                                        <!-- 💾 Auto Save Toggle -->
                                        <HorizontalStackLayout Spacing="8">
                                            <Label Text="Auto Save Ignore File"
                               FontSize="14"
                               VerticalOptions="Center"
                               TextColor="{AppThemeBinding Light=Black, Dark=White}" />
                                            <Switch IsToggled="{Binding OptionsPanel.AutoSaveIgnoreFile}" />
                                        </HorizontalStackLayout>

                                        <!-- Add more settings here -->

                                    </VerticalStackLayout>
                                </Border>
                            </Grid>

                            <!-- 🪟 Tab Handle (attached to panel) -->
                            <Border BackgroundColor="{AppThemeBinding Light=#cccccc, Dark=#444444}"
                Stroke="{AppThemeBinding Light=Gray, Dark=DarkGray}"
                StrokeShape="RoundRectangle 4"
                Padding="6"
                WidthRequest="32"
                HeightRequest="80"
                HorizontalOptions="End"
                VerticalOptions="Center"
                Margin="0,0,-8,0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding OptionsPanel.TogglePanelCommand}" />
                                </Border.GestureRecognizers>
                                <Label Text="⚙️"
                   FontSize="18"
                   HorizontalOptions="Center"
                   VerticalOptions="Center"
                   TextColor="{AppThemeBinding Light=Black, Dark=White}" />
                            </Border>

                        </Grid>

                    </AbsoluteLayout>
                </Grid>
            </controls:HorizontalSplitterView.Panel2Content>
        </controls:HorizontalSplitterView>

        <!-- 📌 Footer -->
        <Label Grid.Row="3" Text="v1.0 • TreeGlyph" FontSize="10" HorizontalOptions="Center" />
    </Grid>
</ContentPage>